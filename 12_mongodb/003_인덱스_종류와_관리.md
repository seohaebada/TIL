# mongoDB 인덱스 종류와 관리

## 고유 인덱스

- 고유 인덱스는 각 값이 인덱스에 최대 한번 나타나도록 보장한다. 
  - 예) 여러 도큐먼트에서 "firstname" 키에 동일한 값을 가질 수 없도록 하면 "firstname" 필드가 있는 도큐먼트에 대해서만 "partialFilterExpression"으로 고유 인덱스를 만들면 된다.
  ```
    db.users.createIndex({"firstname" : 1}, {unique : true, partialFilterExpression : {firstname : {$exists : true}}})
  ```
- 도큐먼트에 키가 존재하지 않으면 인덱스는 그 도큐먼트에 대해 값을 null로 저장한다.
  - 고유 인덱스를 생성한 후 인덱싱된 필드가 없는 도큐먼트를 2개 이상 삽입하려고하면, 이미 null 값이 존재하므로 실패한다.
- 인덱스 버킷은 크기 제한이 있으며, 제한을 넘는 인덱스 항목은 오류나 경고 없이 인덱스에 포함되지 않는다.

### 중복 제거하기
- 기존 컬렉션에 고유 인덱스를 구축할때 중복된 값이 있으면 실패한다.

<br/>

## 복합 고유 인덱스

- 복합 고유 인덱스(compound unique index)는 2개 이상의 키 조합으로 설정된다.
- 모든 키에 걸친 값의 조합은 인덱스에서 최대 한번만 나타난다.

<br/>

## 부분 인덱스

- 오직 키가 존재할때만 고유 인덱스가 작용되도록 할때가 많은데, 고유한 필드가 존재하지 않거나 필드가 아예 존재하지 않으면 "unique"와 "partial"을 결합할 수 있다.
- 부분 인덱스를 만들려면 "partialFilterExpression" 옵션을 포함시킨다.
- 부분 인덱스는 생성하려는 필터 표현식을 나타내는 도큐먼트와 함께 희소 인덱스가 제공하는 기능의 슈퍼셋을 나타낸다.
  - 예) 이메일 주소는 선택 항목이지만 입력할 경우 고유해야한다.
  ```
    db.users.ensureIndex({"email" : 1}, {unique : true, partialFilterExpression : {firstname : {$exists : true}}})
  ```
- 부분 인덱스는 반드시 고유할 필요는 없다. uique 옵션으로 제어할 수 있다.
- 컬렉션에서 1개의 도큐먼트만 부분인덱스인 email을 갖지 않는다고 할때, email로 쿼리할 경우 없는 도큐먼트는 반환되지 않는다.
  - 이런 경우에 필드가 없는 도큐먼트가 필요할 경우에는 hint를 사용함으로써 테이블 스캔을 하도록 강제할 수 있다.

<br/>

## 인덱스 관리

- 데이터베이스의 인덱스 정보는 모두 system.indexes 컬렉션에 저장된다. 
- 인덱스 정보 확인이 가능하다.
  - `db.컬렉션명.getIndexes()`

<br/>

## 인덱스 식별

- 컬렉션 내 각 인덱스는 고유하게 식별하는 이름이 있다.
- 인덱스명은 서버에서 인덱스를 삭제하거나 조작하는데 사용된다.
- 인덱스의 키가 `키명X`, 인덱스의 방향이 `방향X(1 혹은 -1)`일 때
  - 인덱스 명 : 기본적으로 키명1_방향1_키명2_방향2_..._키명N_방향N이다.
  - 인덱스 키가 두개 이상이면 인덱스명이 길어질 수 있으므로 createIndex에 "name" 옵션으로 인덱스명을 지정할 수 있다.

<br/>

## 인덱스 변경

- 인덱스를 삭제할 수 있다.
  - `db.people.dropIndex("x_1_y_1)`
- 인덱스를 구축하려면 시간이 오래 걸리고 리소스가 많이 필요하다.
  - 몽고DB 4.2 이후 버전에서는 인덱스를 최대한 빨리 구축하기 위해, 구축이 완료될때까지 데이터베이스의 모든 읽기와 쓰기를 중단한다.
  - 데이터베이스가 읽기와 쓰기에 어느 정도 응답하게 하려면 인덱스를 구축할때 `"background"` 옵션을 사용한다.
  - 몽고DB 4.2는 하이브리드 인덱스 구축이라는 새로운 접근 방식을 도입했다.
    - 인덱스 구축 프로세스의 시작과 끝에만 락을 가지며, 프로세스의 나머지 부분은 읽기 및 쓰기 작업을 인터리빙한다.



