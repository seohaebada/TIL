# mongoDB explain 출력 

## explain

- 쿼리에 대한 많은 정보를 제공하며, 느린 쿼리를 위한 중요한 진단 도구
- 쿼리의 explain 출력을 보면 어떤 인덱스가 어떻게 사용되는지 알 수 있다.
- 어떤 쿼리든 마지막에 explain 호출을 추가할 수 있다.
- 인덱스를 사용하지 않는 쿼리의 explain이 가장 일반적이다.
  - 쿼리가 "COLLSCAN"을 사용하면 인덱스를 사용하지 않음을 알 수 있다.
- "totalDocsExamined"와 "totalKeysExamine"이 동일하다면, 몽고DB는 인덱스를 사용해 일치하는 모든 도큐먼트를 찾았다.

<br/>

## explain 필드

| 필드                  | 설명                                                                                |
|:---------------------:|:-----------------------------------------------------------------------------------:|
| nReturned           | 실제로 반환된 도큐먼트 개수                                                                   |
| isMultiKey          | 다중키 인덱스 사용 여부(true/false)                                                         |
| totalDocsExamined   | 몽고DB가 디스크 내 실제 도큐먼트를 가리키는 인덱스 포인터를 따라간 횟수                                         |
| totalKeysExamined   | 인덱스가 사용됐다면 살펴본 인덱스 항목 개수, 테이블 스캔을 했다면 조사한 도큐먼트 개수                                 |
| stage               | 몽고DB가 인덱스를 사용해 쿼리할 수 있었는지 여부 ("COLSCAN"은 인덱스로 쿼리할 수 없어 컬렉션 스캔을 수행함을 의미)           |
| needYields          | 쓰기 요청을 처리하도록 쿼리가 양보(일시 중지)한 횟수, 대기 중인 쓰기가 있다면 쿼리는 일시적으로 락(lock)을 해제하고 쓰기가 처리되게한다. |
| executionTimeMillis | 데이터베이스가 쿼리하는데 걸린 시간 (밀리초 단위이며 낮을 수록 좋다.)                                          |
| indexBounds         | 인덱스가 어떻게 사용됐는지 설명하며, 탐색한 인덱스의 범위를 제공한다.                                           |


<br/>

## 인덱스를 생성하지 않는 경우 

- 인덱스는 컬렉션에서 가져와야하는 부분이 많을수록 비효율적인데, 인덱스를 하나 사용하려면 두번의 조회를 해야하기 때문이다.
  - 1) 인덱스 항목을 살펴보고,
  - 2) 도큐먼트를 가리키는 인덱스의 포인터를 따라간다.
- 컬렉션 스캔을 할때는 도큐먼트만 살펴보면 된다. 
- 최악의 경우(컬렉션의 모든 도큐먼트를 반환해야 할때) 인덱스를 사용하면 두배나 많은 조회를 수행하며 이는 대체로 컬렉션 스캔보다 훨씬 느리다.
- 아쉽게도 인덱스가 도움이 될지 혹은 방해가 될지 알 수 있는 공식은 없다.

### 인덱스의 효과에 영향을 미치는 속성 

| 인덱스가 적합한 경우 | 컬렉션 스캔이 적합한 경우 |
|:-----------:|:--------------:|
|    큰 컬렉션    |     작은 컬렉션     |
|   큰 도큐먼트    |    작은 도큐먼트     |
|   선택적 쿼리    |     비선택적 쿼리     |

- [Q] 선택적 쿼리 vs 비선택적 쿼리의 차이?
  - [A]
  - 선택적 쿼리 : 동등 부분 (=)
  - 비선택적 쿼리 : 다중값 부분 (&gt 등)